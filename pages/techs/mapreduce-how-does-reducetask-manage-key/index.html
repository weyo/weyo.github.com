<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Hadoop 源码走读之 Key 的变与不变
   - Let There Be Light
</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel = "Shortcut Icon" href=https://raw.githubusercontent.com/weyo/weyo.github.com/master/images/photos/avatar.png>

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Hadoop 源码走读之 Key 的变与不变"/>
            <meta property="og:url" content="http://weyo.me/pages/techs/mapreduce-how-does-reducetask-manage-key/"/>
            <meta property="og:description" content="由于 MapReduce 在任务调度时使用同一个 Text 对象来传递数据，所以在直接使用该对象进行规约时就会出现问题。因此，在 Reducer 中接收新数据时务必要将 Text 转化为 String，或者创建新的 Text 对象来进行处理。"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://weyo.me/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://weyo.me/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://weyo.me/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="http://weyo.me/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>

        <link href="http://weyo.me/feeds/all.rss.xml" type="application/atom+xml" rel="alternate"
              title="Let There Be Light RSS Feed"/>

    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-46991080-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://weyo.me" class="navbar-brand">Let There Be Light</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://weyo.me/pages/about.html">
                             About
                          </a></li>
                         <li><a href="http://weyo.me/pages/gallery.html">
                             Gallery
                          </a></li>
                        <li >
                            <a href="http://weyo.me/category/essays.html">Essays</a>
                        </li>
                        <li class="active">
                            <a href="http://weyo.me/category/techs.html">Techs</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://weyo.me/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://weyo.me/pages/techs/mapreduce-how-does-reducetask-manage-key/"
                       rel="bookmark"
                       title="Permalink to Hadoop 源码走读之 Key 的变与不变">
                        Hadoop 源码走读之 Key 的变与不变
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>2015-07-02
    </span>
	<span style="font-size:12px;">&nbsp;&nbsp;</span>
    <!--     <span class="label label-default">By</span>
    <a href="http://weyo.me/author/weyo.html"><i class="icon-user"></i>WeYo</a>
	<span style="font-size:12px;">&nbsp;&nbsp;</span>
 -->

    <span class="label label-default">Category</span>
    <a href="http://weyo.me/category/techs.html">Techs</a>
	<span style="font-size:12px;">&nbsp;&nbsp;</span>


<span class="label label-default">Tags</span>
	<a href="http://weyo.me/tag/hadoop.html">Hadoop</a>
        /
	<a href="http://weyo.me/tag/mapreduce.html">MapReduce</a>
	
	<br /><br />Posted by <span style="font-weight:bold;"><a href="http://github.com/weyo">WeYo</a></span>. 转载请注明出处：<a href="http://weyo.me/pages/techs/mapreduce-how-does-reducetask-manage-key/">http://weyo.me/pages/techs/mapreduce-how-does-reducetask-manage-key/</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <h1>Issues</h1>
<p>最近在写 MapReduce Job 时发现 Reducer 输出的结果总是一组完全相同的 Key，而每个 Key 对应的 Value 却不尽相同。以最简单的 word-count 为例，假设我们有一个表示“特征”的对象 <code>Feature</code>（为简单起见，这里省略了部分构造器、方法）：</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">Feature</span> {
    <span class="n">String</span> <span class="n">attribute</span>;
    <span class="nb">int</span> <span class="nb">num</span>;

    <span class="nv">@Override</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">toString</span>() {
        <span class="k">return</span> <span class="n">String</span>.<span class="n">format</span>(<span class="s">&quot;[attribute=%s,num=%d]&quot;</span>, <span class="n">attribute</span>, <span class="nb">num</span>);    
    }
}
</pre></div>


<p>Map 对象读取 sentence 中的第一个 word，并写入 <code>Feature</code> 对象：</p>
<div class="highlight"><pre><span></span>//map
    private word  = new Text();

    @Override
    public void map(Object key, Text value, Context context)
            throws IOException, InterruptedException {
        String line = value.toString();
        String[] words = line.split(&quot;\\|&quot;);
        String w = words[0];

        word.set(w);
        Feature f = new Feature(w, one);
        context.write(word, f);
    }
</pre></div>


<p>在 Reduce 对象中分两步处理，第一步是将收到的同类 <code>Feature</code> 进行汇总（汇总到一个 <code>HashMap</code> 中），然后在汇总完毕之后对结果进行统一处理：</p>
<div class="highlight"><pre><span></span><span class="o">//</span> <span class="nt">reduce</span>
    <span class="nt">private</span> <span class="nt">Map</span><span class="o">&lt;</span><span class="nt">Text</span><span class="o">,</span> <span class="nt">Feature</span><span class="o">&gt;</span> <span class="nt">map</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">HashMap</span><span class="o">&lt;</span><span class="nt">Text</span><span class="o">,</span> <span class="nt">Feature</span><span class="o">&gt;();</span>

    <span class="k">@Override</span>
    <span class="nt">public</span> <span class="nt">void</span> <span class="nt">reduce</span><span class="o">(</span><span class="nt">Text</span> <span class="nt">key</span><span class="o">,</span> <span class="nt">Iterable</span><span class="o">&lt;</span><span class="nt">Feature</span><span class="o">&gt;</span> <span class="nt">values</span><span class="o">,</span> <span class="nt">Context</span> <span class="nt">context</span><span class="o">)</span>
            <span class="nt">throws</span> <span class="nt">IOException</span><span class="o">,</span> <span class="nt">InterruptedException</span> <span class="p">{</span>
        <span class="nt">Feature</span> <span class="nt">sum</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">Feature</span><span class="o">(</span><span class="nt">key</span><span class="nc">.toString</span><span class="o">());</span>
        <span class="nt">for</span> <span class="o">(</span><span class="nt">Feature</span> <span class="nt">f</span> <span class="o">:</span> <span class="nt">values</span><span class="o">)</span> <span class="p">{</span>
            <span class="n">sum</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nt">map</span><span class="nc">.put</span><span class="o">(</span><span class="nt">key</span><span class="o">,</span> <span class="nt">sum</span><span class="o">);</span>
    <span class="p">}</span>

    <span class="k">@Override</span>
    <span class="nt">public</span> <span class="nt">void</span> <span class="nt">cleanup</span><span class="o">(</span><span class="nt">Context</span> <span class="nt">context</span><span class="o">)</span> <span class="nt">throws</span> <span class="nt">IOException</span><span class="o">,</span>
            <span class="nt">InterruptedException</span> <span class="p">{</span>
        <span class="nt">System</span><span class="nc">.out.println</span><span class="o">(</span><span class="s2">&quot;Within Reduce, we got a map: &quot;</span> <span class="o">+</span> <span class="nt">map</span><span class="o">);</span>
        <span class="o">//</span> <span class="nt">do</span> <span class="nt">something</span>
    <span class="p">}</span>
</pre></div>


<p>运行这个 Job 就会出现类似下面的结果：</p>
<div class="highlight"><pre><span></span>Within Reduce, we got a map: {Tag=[attribute=Col,num=25], Tag=[attribute=Tag,num=13], Tag=[attribute=Row,num=37]}
</pre></div>


<p>这里可以看出，生成的 map 中所有的 key 值完全相同，不同的仅仅是 value 值。</p>
<hr />
<h1>Analysis</h1>
<p>由于 HashMap 是根据对象的哈希值来确定 key 的位置的，而这些 key 值相同却能存放到不同的位置，说明这些 key 对象（这里是 <code>Text</code> 对象）必然有着不同的哈希值。根据这一点就能逐步推断出问题的根源。</p>
<h2>Speculation</h2>
<p>进一步在 debug 模式下运行 Job 可以发现，在 <code>reduce</code> 方法中，map 的每一个 put 操作都会造成 map 中所有已有的 key 的变化。一开始我认为这可能是由于 <code>reduce</code> 方法中传入了不同的 <code>Text</code> 对象，而对象中的值的引用（bytes 数组）相同的缘故造成的。因为 <code>Text</code> 中的 bytes 数组并不是一个 final 对象，而是在每次 set 的过程中都会变化的。<code>Text</code> 在写入过程中如果发现输入数据大小与本身的 bytes 大小一致，就会使用 <code>System.arraycopy(utf8, start, bytes, 0, len);</code> 直接将输入数组拷贝到已有的 bytes 数组中，而不会创建新的 bytes 对象来进行写入操作，也就是说，如果每次写入的对象大小不变，那么 <code>Text</code> 中的 bytes 域也是不会发生变化的。由于这里的 Job 中处理的 key 都是相同大小的字符串，也就是说 <code>Text</code> 对象中的引用不会变化，这有可能会导致所有的 <code>Text</code> 对象共用同一个 bytes 引用，从而出现新的 <code>Text</code> 对象的变化引起所有对象变化的问题。那么这个问题会不会就是由于这个原因造成的呢？</p>
<p>答案是否定的。</p>
<p>上面所述的情况只有可能在一种场景下出现，那就是新的 <code>Text</code> 对象通过调用旧的 <code>Text</code> 对象中的 bytes 数组来构造，如下面的这段代码所示：</p>
<div class="highlight"><pre><span></span>// A fictitious example
Text oldtext = new Text();
oldtext.set(string1);
Text newtext = new Text(oldtext.getBytes());
newtext.set(string2);
</pre></div>


<p>但是，如果去运行这段代码，你会发现 <code>oldtext</code> 和 <code>newtext</code> 并不包含相同的引用，这是因为在构造 <code>Text</code> 对象时，程序会先通过 <code>setCapacity</code> 方法来检查自身的 bytes：</p>
<div class="highlight"><pre><span></span>  private void setCapacity(int len, boolean keepData) {
    if (bytes == null || bytes.length &lt; len) {
      if (bytes != null &amp;&amp; keepData) {
        bytes = Arrays.copyOf(bytes, Math.max(len,length &lt;&lt; 1));
      } else {
        bytes = new byte[len]; // case when bytes is null
      }
    }
  }
</pre></div>


<p>如果 bytes 为空（在构造 <code>Text</code> 时这是成立的），那么会创建一个全新的 bytes 数组，而不会直接复用已有的数组，这也是 <code>Text</code> 的一种安全性保障机制。</p>
<p>那么，如果不是这个原因那会是什么原因造成的呢？</p>
<h2>Hashes in Java</h2>
<p>我们再回过头来复习下 Java 中使用了哈希算法的集合。在 <code>HashMap</code> 、<code>HashSet</code> 这样的集合中，对于对象哈希值的计算都是通过下面的方法实现的：</p>
<div class="highlight"><pre><span></span>    final int hash(Object k) {
        int h = hashSeed;
        if (0 != h &amp;&amp; k instanceof String) {
            return sun.misc.Hashing.stringHash32((String) k);
        }

        h ^= k.hashCode(); // 哈希计算的关键步骤

        // This function ensures that hashCodes that differ only by
        // constant multiples at each bit position have a bounded
        // number of collisions (approximately 8 at default load factor).
        h ^= (h &gt;&gt;&gt; 20) ^ (h &gt;&gt;&gt; 12);
        return h ^ (h &gt;&gt;&gt; 7) ^ (h &gt;&gt;&gt; 4);
    }
</pre></div>


<p>可以看出，对于非 String 类型的对象，是通过调用对象本身的 <code>hashCode</code> 方法来计算哈希值的。这一点对于理解 <code>Text</code> 对象的一致性非常重要。</p>
<h2>Hashes in Hadoop</h2>
<p>再来看 <code>Text</code> 对象的 <code>hashCode</code> 实现。<code>Text</code> 的哈希值计算直接使用的父类 <code>BinaryComparable</code> 的 <code>hashCode</code> 方法实现的，而 <code>BinaryComparable</code> 最终又是通过下面的方法来实现哈希计算的：</p>
<div class="highlight"><pre><span></span>  public static int hashBytes(byte[] bytes, int offset, int length) {
    int hash = 1;
    for (int i = offset; i &lt; offset + length; i++)
      hash = (31 * hash) + (int)bytes[i];
    return hash;
  }
</pre></div>


<p>也就是说，Hadoop 中的这类序列化对象都是通过字节数组的值来计算哈希值的。如果 <code>Text</code> 对象包含的内容（也就是 bytes 数组）发生了变化，那么该对象的哈希值也会相应改变；相对的，如果两个 <code>Text</code> 对象具有相同的字符串内容（也就是 bytes 数组的值相同），那么这两个对象的哈希值就会是相同的。明白了这一点，我们就可以通过 Hadoop 的任务调度机制来最终解决这个问题了。</p>
<h2>Hadoop Task</h2>
<p>我们知道，<code>Reducer</code> 的运行是在 <code>ReducerTask</code> 中定义的：</p>
<div class="highlight"><pre><span></span>  void runNewReducer(...) {
    // initializing...
    try {
      reducer.run(reducerContext);
    } finally {
      trackedRW.close(reducerContext);
    }
  }
</pre></div>


<p>由于 <code>Reducer</code> 默认是以一种循环遍历的方式处理数据的，这里的 <code>reducerContext</code> 是伴随着 reducer 的整个生命周期的：</p>
<div class="highlight"><pre><span></span>  public void run(Context context) throws IOException, InterruptedException {
    setup(context);
    try {
      while (context.nextKey()) {
        reduce(context.getCurrentKey(), context.getValues(), context);
        // If a back up store is used, reset it
        Iterator&lt;VALUEIN&gt; iter = context.getValues().iterator();
        if(iter instanceof ReduceContext.ValueIterator) {
          ((ReduceContext.ValueIterator&lt;VALUEIN&gt;)iter).resetBackupStore();        
        }
      }
    } finally {
      cleanup(context);
    }
  }
</pre></div>


<p>可以看出，这里的 context 通过 <code>nextKey</code> 来判断是否还有输入值，再调用 <code>getCurrentKey</code> 和 <code>getValues</code> 来获取相应的 key 与 values。而 Context 的最终实现类就是 <code>org.apache.hadoop.mapreduce.task.ReduceContextImpl&lt;KEYIN,VALUEIN,KEYOUT,VALUEOUT&gt;</code>。</p>
<p>继续观察 <code>ReduceContextImpl</code> 会发现，<code>Context</code> 中的 key 对象是保持不变的，也就是说，key 引用本身不变，改变的只是 key 中的域的取值（类似于添加了 final 关键字的效果）：</p>
<div class="highlight"><pre><span></span>private KEYIN key;
key = keyDeserializer.deserialize(key);
</pre></div>


<p>对于 <code>Text</code> 类型对象，这里的 keyDeserializer 就是 <code>org.apache.hadoop.io.serializer.WritableSerialization.WritableDeserializer</code>，它的反序列化操作非常简单粗暴：</p>
<div class="highlight"><pre><span></span>    public Writable deserialize(Writable w) throws IOException {
      Writable writable;
      if (w == null) {
        writable 
          = (Writable) ReflectionUtils.newInstance(writableClass, getConf());
      } else {
        writable = w;
      }
      writable.readFields(dataIn);
      return writable;
    }
</pre></div>


<p>对于 null 对象，上述方法会创建一个新的 <code>Writable</code> 对象，而对于已有的对象，则会直接返回原对象，只是在返回之前先读入输入流中的数据。这里的输入流也是在 <code>Context</code> 中定义好的：</p>
<div class="highlight"><pre><span></span>// initialize
private RawKeyValueIterator input;
private DataInputBuffer buffer = new DataInputBuffer();
this.keyDeserializer.open(buffer);

// nextKey()
DataInputBuffer nextKey = input.getKey();
currentRawKey.set(nextKey.getData(), nextKey.getPosition(), 
                  nextKey.getLength() - nextKey.getPosition());
buffer.reset(currentRawKey.getBytes(), 0, currentRawKey.getLength());
</pre></div>


<p>到这里顺便说一下 <code>RawKeyValueIterator</code>，它是真正用于获取 sort/merge 过程中产生的原始数据的迭代器。从实际实现类 <code>org.apache.hadoop.mapred.Merger.MergeQueue&lt;K, V&gt;</code> 的源码中可以看出，它是通过一个基于小根堆结构的 <code>PriorityQueue</code> 队列来实现有序的数据消费的。</p>
<h2>Summary</h2>
<p>从上面的叙述中我们已经知道了，不论数据生产的方式是什么样的，对于 <code>Reducer</code> 而言，它接收到的 <code>Text</code> 永远是同一个对象，变化的只是 <code>Text</code> 中 bytes 的取值。这大概可以称为 reduce 中 key 的不变性。这种对象本身的不变性加上实际取值的变化以及哈希值计算方法，就是造成本文开头所述问题的根本原因。我们再用一段代码来模拟一下 Hadoop 中 Reduce 任务运行的基本过程。</p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">me</span><span class="o">.</span><span class="n">weyo</span><span class="o">.</span><span class="n">mapred</span><span class="o">.</span><span class="n">testing</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.DataInputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.apache.hadoop.conf.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.io.DataInputBuffer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.io.Text</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.io.Writable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.util.GenericOptionsParser</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.util.ReflectionUtils</span><span class="p">;</span>

<span class="o">/**</span>
 <span class="o">*</span> <span class="nd">@author</span> <span class="n">weyo</span>
 <span class="o">*</span> <span class="nd">@date</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">1</span>
 <span class="o">*/</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">MapKeys</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">static</span> <span class="n">Class</span><span class="o">&lt;</span><span class="err">?</span><span class="o">&gt;</span> <span class="n">writableClass</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">static</span> <span class="n">DataInputStream</span> <span class="n">dataIn</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">static</span> <span class="n">Configuration</span> <span class="n">conf</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">Writable</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Writable</span> <span class="n">w</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">Writable</span> <span class="n">writable</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">writable</span> 
            <span class="o">=</span> <span class="p">(</span><span class="n">Writable</span><span class="p">)</span> <span class="n">ReflectionUtils</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span><span class="n">writableClass</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">writable</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">writable</span><span class="o">.</span><span class="n">readFields</span><span class="p">(</span><span class="n">dataIn</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">writable</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Text</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nb">map</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Text</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="o">//</span> <span class="err">模拟一般</span> <span class="n">MR</span> <span class="n">Job</span> <span class="err">的初始化过程</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Configuration</span><span class="p">();</span>
        <span class="n">new</span> <span class="n">GenericOptionsParser</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="n">writableClass</span> <span class="o">=</span> <span class="n">Text</span><span class="o">.</span><span class="n">class</span><span class="p">;</span>
        <span class="n">Text</span> <span class="n">text</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Text</span> <span class="err">使用</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="err">编码格式</span>
        <span class="n">byte</span><span class="p">[]</span> <span class="n">obytes</span> <span class="o">=</span> <span class="s2">&quot;1st&quot;</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">);</span>
        <span class="o">//</span> <span class="err">注意，这里</span> <span class="nb">bytes</span> <span class="err">第一位必须用于设置内容长度，这是</span> <span class="n">Text</span> <span class="err">的变长机制决定的</span>
        <span class="n">byte</span><span class="p">[]</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">new</span> <span class="n">byte</span><span class="p">[</span><span class="n">obytes</span><span class="o">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="nb">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">obytes</span><span class="o">.</span><span class="n">length</span><span class="p">;</span>
        <span class="n">System</span><span class="o">.</span><span class="n">arraycopy</span><span class="p">(</span><span class="n">obytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">obytes</span><span class="o">.</span><span class="n">length</span><span class="p">);</span>
        <span class="n">DataInputBuffer</span> <span class="nb">buffer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DataInputBuffer</span><span class="p">();</span>
        <span class="n">dataIn</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DataInputStream</span><span class="p">(</span><span class="nb">buffer</span><span class="p">);</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">length</span><span class="p">);</span>
        <span class="o">//</span> <span class="err">第一次读入数据</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">Text</span><span class="p">)</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">toString</span><span class="p">());</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">text</span> <span class="o">+</span> <span class="s2">&quot;|text.hashCode=&quot;</span> <span class="o">+</span> <span class="n">text</span><span class="o">.</span><span class="n">hashCode</span><span class="p">());</span>
        <span class="n">obytes</span> <span class="o">=</span> <span class="s2">&quot;2nd&quot;</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">);</span>
        <span class="n">System</span><span class="o">.</span><span class="n">arraycopy</span><span class="p">(</span><span class="n">obytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">obytes</span><span class="o">.</span><span class="n">length</span><span class="p">);</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">length</span><span class="p">);</span>
        <span class="o">//</span> <span class="err">第二次读入数据</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">Text</span><span class="p">)</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">toString</span><span class="p">());</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">text</span> <span class="o">+</span> <span class="s2">&quot;|text.hashCode=&quot;</span> <span class="o">+</span> <span class="n">text</span><span class="o">.</span><span class="n">hashCode</span><span class="p">());</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;Map|&quot;</span> <span class="o">+</span> <span class="nb">map</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>这段代码的输出结果为</p>
<div class="highlight"><pre><span></span>1st|text.hashCode=80561
2nd|text.hashCode=81351
Map|{2nd=2nd, 2nd=1st}
</pre></div>


<p>与我们预想的完全一致。理解了原理之后，我们接下来就可以想办法去解决它。</p>
<h2>Solutions</h2>
<h3>Final object</h3>
<p>考虑下面的 <code>HashSet</code> 的例子：</p>
<div class="highlight"><pre><span></span>HashSet&lt;Date&gt; set = new HashSet&lt;Date&gt;();
Date date = new Date();
set.add(date);
date.setTime(System.currentTimeMillis() + 60000); // 增加 1 分钟时间
set.add(date);
System.out.println(set);
</pre></div>


<p>这段代码的输出结果大概是这样的：</p>
<div class="highlight"><pre><span></span>[Thu Jul 02 19:02:36 CST 2015, Thu Jul 02 19:02:36 CST 2015]
</pre></div>


<p>也就是说 set 中的两个 <code>Date</code> 对象完全相同（其实就是同一个对象）。这段代码的原理与上文所述的 Hadoop 代码的工作原理完全相同。在这里 <code>HashSet</code> 实际上是使用了两个 hash 位来保存同一个对象的引用。<code>Date</code> 是 JDK 中难得的与 <code>Text</code> 性质相似的对象 —— 拥有可变的 field，并且根据该 field 来计算哈希值。也由于 <code>Date</code> 的这种可变性，使得 <code>Date</code> 很多时候对于“时间”这个概念的语义表达并不够准确，所以在 JDK 5 之后的版本也已经不推荐使用 <code>Date</code> 来表示时间对象（大部分方法被设置为 <code>@Deprecated</code>）。</p>
<p>再回到这个问题上来，既然这个问题是由于 <code>Date</code> 的可变性引起的，那么将 <code>Date</code> 转化成某种“不可变”的对象不就可以解决问题了。以下几种方式均可以实现这个目标：</p>
<ul>
<li>每次向 set 中存入一个新的 <code>Date</code> 对象：
  <code>set.add(new Date(date.getTime()));</code></li>
<li><code>HashSet</code> 不直接处理 <code>Date</code>，而是处理 <code>Date</code> 中的 time 域：</li>
</ul>
<p><code>HashSet&lt;Long&gt; set = new HashSet&lt;Long&gt;();
  set.add(date.getTime());</code></p>
<p>而对于本文开始的例子中提到的 reduce 任务，相应的也有两种解决方法：</p>
<ul>
<li>
<p>向 map 中存入新的 <code>Text</code> 对象：
  <code>map.put(new Text(key), sum);</code></p>
</li>
<li>
<p><code>HashMap</code> 直接处理 <code>Text</code> 中保存的字符串信息：
  <code>Map&lt;String, Feature&gt; map = new HashMap&lt;String, Feature&gt;();
  map.put(key.toString(), sum);</code></p>
</li>
</ul>
<h3>Different data structure</h3>
<p>由于这个问题是哈希集合数据结构的特征造成的，那么更换一种数据结构也是可以解决问题的。对于 <code>HashSet</code> 的例子，可以使用 <code>TreeSet</code> 来代替；对于 <code>HashMap</code> 的例子就可以使用 <code>TreeMap</code> 来代替（前提是 key 必须实现 <code>Comparable</code> 接口，不过 Hadoop 的序列化对象基本上都符合这个条件）。不过由于 <code>TreeSet</code> 与 <code>TreeMap</code> 只允许保存同一个对象的一个引用，这里的 add/put 操作必须针对 new 的新对象。这一点与上面的存入新对象的思路相似，只是使用 Tree 结构之后可以实现更多功能（比如 key 的自动排序），同时也能够更好地定位问题。</p>
<div class="highlight"><pre><span></span>Map&lt;Text, Feature&gt; map = new TreeMap&lt;Text, Feature&gt;();
map.put(new Text(key), sum);
</pre></div>


<h1>Conclusion</h1>
<p>写到这里差不多该结束了。简单总结一下，由于 MapReduce 在任务调度时使用同一个 <code>Text</code> 对象来传递数据，所以在直接使用该对象进行规约时就会出现问题。因此，在 <code>Reducer</code> 中接收新数据时务必要将 <code>Text</code> 转化为 <code>String</code> ，或者创建新的 <code>Text</code> 对象来进行处理（相比之下前一种方法效率可能会更高一点）。对于这个对象不变性问题，本来想向社区提交一个 patch 来改进，但是回过头再想想其实 Hadoop 这么做也无不可。虽然现代的 JVM 对于小对象的频繁创建已经有了很好的性能支持，但是减少创建对象的频率来提高集群性能也没什么错（虽然这点性能提升可能微乎其微），而且 Hadoop 发展了这么多年，到今天这样比较稳定成熟的版本也证明了这种思路没有什么问题。对于程序员来说，不改总比少改好（As we all know the joke, "99 bugs in the code. Fix one bug, compile it down. 167 little bugs in the code....sigh".）。因此，最终还需要我们在编写新任务时理解、注意其中的细节，争取写出具有高鲁棒性的程序。</p>
<p>That's all.</p>
<hr />
<h1>Reference</h1>
<ol>
<li><a href="http://yoyzhou.github.io/blog/2013/05/10/hadoop-serialization-and-writable-object-2/">http://yoyzhou.github.io/blog/2013/05/10/hadoop-serialization-and-writable-object-2/</a></li>
<li><a href="http://blog.csdn.net/posa88/article/details/7906426">http://blog.csdn.net/posa88/article/details/7906426</a></li>
<li><a href="http://blog.csdn.net/lastsweetop/article/details/9249411">http://blog.csdn.net/lastsweetop/article/details/9249411</a></li>
</ol>
            </div>
            <!-- /.entry-content -->
<hr />
<ul style="list-style-type: none; margin-left: -38px">
     <li style="margin-top: 5px">
         <span class="label label-default"><i class="icon-chevron-up"></i>上一篇</span>
         <a href="http://weyo.me/pages/techs/storm-documents-translation/">
             Storm 官方文档翻译说明
         </a>
     </li>
     <li>
         <span class="label label-default"><i class="icon-chevron-down"></i>下一篇</span>
         <a href="http://weyo.me/pages/techs/not-able-to-use-latest-kafka-consumer-api/">
             Not able to use latest Kafka Consumer API
         </a>
     </li>
</ul>    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'weyo'; // required: replace example with your forum shortname
            var disqus_identifier = 'mapreduce-how-does-reducetask-manage-key';
            var disqus_url = 'http://weyo.me/pages/techs/mapreduce-how-does-reducetask-manage-key/';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item">
					    <i class="icon-github-sign icon-large"></i>
					    <a href="https://github.com/weyo/">Github</a>
				    </li>
                    <li class="list-group-item">
					    <i class="icon-linkedin-sign icon-large"></i>
					    <a href="https://cn.linkedin.com/in/weiyong">LinkedIn</a>
				    </li>
                <li class="list-group-item"><h4><i class="icon-link icon-large"></i>Links</h4></li>
                    <li class="list-group-item"><a href="http://getpelican.com/"><i
                            class="icon-Pelican-sign icon-large"></i>Pelican
                    </a></li>
                    <li class="list-group-item"><a href="#"><i
                            class="icon-WeYo-sign icon-large"></i>WeYo
                    </a></li>


                <li class="list-group-item"><a href="http://weyo.me/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                        <li class="list-group-item tag-1">
                            <a href="http://weyo.me/tag/translation.html">
                                translation
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://weyo.me/tag/storm.html">
                                Storm
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://weyo.me/tag/fen-bu-shi-ji-suan.html">
                                分布式计算
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://weyo.me/tag/huan-jing-da-jian.html">
                                环境搭建
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://weyo.me/tag/shi-shi-ji-suan.html">
                                实时计算
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://weyo.me/tag/kafka.html">
                                Kafka
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://weyo.me/tag/linux.html">
                                Linux
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://weyo.me/tag/java.html">
                                Java
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://weyo.me/tag/hadoop.html">
                                Hadoop
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://weyo.me/tag/algorithm.html">
                                Algorithm
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://weyo.me/tag/mapreduce.html">
                                MapReduce
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/undefined.html">
                                Undefined
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/log4j.html">
                                log4j
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/yaml.html">
                                Yaml
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/gnome.html">
                                Gnome
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/virtualbox.html">
                                VirtualBox
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/windows.html">
                                Windows
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/zookeeper.html">
                                ZooKeeper
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/benchmark.html">
                                Benchmark
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/flume.html">
                                Flume
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/magic-mirror.html">
                                Magic Mirror
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/jedis.html">
                                Jedis
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/redis.html">
                                Redis
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/rpc.html">
                                RPC
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://weyo.me/tag/shell.html">
                                Shell
                            </a>
                        </li>
        </ul>
    </section>
</aside>        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <p class="pull-right"><i class="icon-arrow-up"></i> <a href="#">Back to top</a></p>


        <p>&copy; 2016 WeYo &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></p>
    </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://weyo.me/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://weyo.me/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'weyo'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>


</body>
</html>